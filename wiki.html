<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    @STYLESHEETS@
  </head>
  <body>
    <style>
.hidden {
  display: none
}
    </style>
    <script>
function actionEdit()
{
  var xhr = new XMLHttpRequest();
  xhr.open('GET', window.location.pathname + "?raw", true);
  xhr.onreadystatechange = function(event) {
      if (xhr.readyState == 4 && xhr.status == 200) {
          document.getElementById("textarea").innerHTML = xhr.responseText;
          document.getElementById("edit").classList.remove("hidden");
          document.getElementById("content").classList.add("hidden");
          document.getElementById("editButton").classList.add("hidden");
          document.getElementById("saveButton").classList.remove("hidden");
      }
    };
  xhr.send();
}

function actionSave()
{
  var xhr = new XMLHttpRequest();
  xhr.open('POST', window.location.pathname + "?commit", true);
  xhr.setRequestHeader("Content-type", "text/plain");
  xhr.onreadystatechange = function(event) {
      if (xhr.readyState == 4 && xhr.status == 200)
          location.reload();
    };
  xhr.send(document.getElementById("textarea").value);
}

function actionSearch(event)
{
  if (event.keyCode === 13) {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', window.location.pathname + "?search=" + event.target.value, true);
    xhr.onreadystatechange = function(event) {
        if (xhr.readyState == 4 && xhr.status == 200) {
            var resultNode = document.getElementById("searchResult");

            while (resultNode.firstChild) // clear previous results
                resultNode.removeChild(resultNode.firstChild);

            results = JSON.parse(xhr.responseText);
            for (i in results) {
                var div = document.createElement('div');
                div.innerHTML = '<a href="' + results[i]['filename'] + '">' + results[i]['filename'] + '</a>';
                var div2 = document.createElement('div');
                div2.innerHTML = results[i]['text'];
                div.appendChild(div2);
                resultNode.appendChild(div);
            }
            resultNode.classList.remove("hidden");
            document.getElementById("content").classList.add("hidden");
        }
      };
    xhr.send();
  }
}
    </script>
    <div style="border: 1px solid gray">
      <h1>@TITLE@</h1>
      <button id="editButton" onclick="actionEdit()">Edit</button>
      <button id="saveButton" class="hidden" onclick="actionSave()">Save</button>
      <input type="text" placeholder="Search" onkeydown="actionSearch(event)">
    </div>
    <div id="edit" class="hidden">
      <textarea style="width:100%;height:500px" id="textarea">
      </textarea>
    </div>
    <div id="searchResult" class="hidden"></div>
    <div id="content">
      @HTML_HERE@
    </div>
  </body>
</html>
